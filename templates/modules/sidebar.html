<aside th:fragment="sidebar" id="z-sidebar">
  <!-- 头部区域（Logo + 标题） -->
  <th:block th:replace="~{modules/header :: header}" />

  <!-- 导航菜单区域 -->
  <nav class="sidebar-nav scrollcheck-y">
    <div
      th:if="${pluginFinder.available('PluginSearchWidget')}"
      class="search-btn sidebar-nav-item gradient-card"
      onclick="SearchWidget.open()"
    >
      <span class="icon-[ph--magnifying-glass-bold]"></span>
      <span class="nav-text">搜索</span>
      <kbd class="search-shortcut" x-data x-text="navigator.platform.includes('Mac') ? '⌘K' : 'Ctrl+K'"></kbd>
    </div>

    <!-- 从 Halo 后台读取的菜单 -->
    <th:block th:with="menu = ${menuFinder.getByName(theme.config.nav.primary)}">
      <menu th:if="${menu != null and menu.menuItems != null}">
        <li
          th:each="menuItem : ${menu.menuItems}"
          th:class="${menuItem.children != null and not #lists.isEmpty(menuItem.children)} ? 'has-submenu' : ''"
        >
          <th:block th:if="${menuItem.children != null and not #lists.isEmpty(menuItem.children)}">
            <div class="sidebar-nav-item has-dropdown">
              <span
                th:if="${not #strings.isEmpty(menuItem.metadata?.annotations?.get('icon'))}"
                th:class="'iconfont ' + ${menuItem.metadata.annotations.get('icon')}"
              >
              </span>
              <span
                th:unless="${not #strings.isEmpty(menuItem.metadata?.annotations?.get('icon'))}"
                class="iconfont icon-file"
              >
              </span>
              <span class="nav-text" th:text="${menuItem.status.displayName}"></span>
              <span class="icon-[ph--caret-down-bold] dropdown-arrow"></span>
            </div>

            <!-- 悬浮下拉子菜单 -->
            <div class="dropdown-menu">
              <a
                th:each="child : ${menuItem.children}"
                th:href="${child.status.href}"
                class="dropdown-item"
                th:attr="target=${(child.spec.target == '_blank' or child.spec.target == 'BLANK') ? '_blank' : ((child.spec.target == '_parent' or child.spec.target == 'PARENT') ? '_parent' : ((child.spec.target == '_top' or child.spec.target == 'TOP') ? '_top' : null))}"
              >
                <span
                  th:if="${not #strings.isEmpty(child.metadata?.annotations?.get('icon'))}"
                  th:class="'iconfont ' + ${child.metadata.annotations.get('icon')}"
                >
                </span>
                <span class="nav-text" th:text="${child.status.displayName}"></span>
              </a>
            </div>
          </th:block>
          <a
            th:unless="${menuItem.children != null and not #lists.isEmpty(menuItem.children)}"
            th:href="${menuItem.status.href}"
            class="sidebar-nav-item"
            th:attr="target=${(menuItem.spec.target == '_blank' or menuItem.spec.target == 'BLANK') ? '_blank' : ((menuItem.spec.target == '_parent' or menuItem.spec.target == 'PARENT') ? '_parent' : ((menuItem.spec.target == '_top' or menuItem.spec.target == 'TOP') ? '_top' : null))}"
          >
            <span
              th:if="${not #strings.isEmpty(menuItem.metadata?.annotations?.get('icon'))}"
              th:class="'iconfont ' + ${menuItem.metadata.annotations.get('icon')}"
            >
            </span>
            <span
              th:unless="${not #strings.isEmpty(menuItem.metadata?.annotations?.get('icon'))}"
              class="iconfont icon-file"
            >
            </span>
            <span class="nav-text" th:text="${menuItem.status.displayName}"></span>
            <span th:if="${menuItem.spec.target == '_blank'}" class="iconfont icon-link external-tip"></span>
          </a>
        </li>
      </menu>
    </th:block>
  </nav>

  <!-- 页脚区域 -->
  <footer class="sidebar-footer">
    <!-- 用户登录/信息 -->
    <div class="user-auth" x-data="userAuth()" @click.outside="showMenu = false">
      <!-- 未登录 -->
      <a x-show="!currentUser" href="/login" class="user-entry">
        <div class="avatar-wrapper">
          <span class="icon-[ph--user-circle-bold] default-avatar-icon"></span>
        </div>
        <div class="user-info">
          <span class="user-name">登录</span>
          <span class="user-desc">点击登录账号</span>
        </div>
      </a>
      
      <!-- 已登录 -->
      <div x-show="currentUser" class="user-entry" @click="handleClick()">
        <div class="avatar-wrapper">
          <img :src="currentUser?.avatar" :alt="currentUser?.name" class="user-avatar" />
        </div>
        <div class="user-info">
          <span class="user-name" x-text="currentUser?.name"></span>
          <span class="user-desc" x-text="currentUser?.isAdmin ? '管理员' : '个人中心'"></span>
        </div>
        <span x-show="currentUser?.isAdmin" class="icon-[ph--caret-down-bold] menu-arrow" :class="{ 'rotate': showMenu }"></span>
      </div>
      
      <!-- 管理员下拉菜单 -->
      <div x-show="showMenu" x-transition class="user-menu">
        <a href="/uc" class="user-menu-item">
          <span class="icon-[ph--user-bold]"></span>
          <span>个人中心</span>
        </a>
        <a href="/console" class="user-menu-item">
          <span class="icon-[ph--gear-six-bold]"></span>
          <span>管理中心</span>
        </a>
        <a href="/logout" class="user-menu-item logout">
          <span class="icon-[ph--sign-out-bold]"></span>
          <span>退出登录</span>
        </a>
      </div>
    </div>

    <!-- 主题切换（三按钮：浅色/深色/跟随系统） -->
    <div class="theme-toggle" x-data="themeToggle()">
      <button :class="{ active: theme === 'light' }" @click="setTheme('light', $event)" title="浅色模式">
        <span class="icon-[ph--sun-bold]"></span>
      </button>
      <button :class="{ active: theme === 'system' }" @click="setTheme('system', $event)" title="跟随系统">
        <span class="icon-[ph--monitor-bold]"></span>
      </button>
      <button :class="{ active: theme === 'dark' }" @click="setTheme('dark', $event)" title="深色模式">
        <span class="icon-[ph--moon-bold]"></span>
      </button>
    </div>

    <!-- 社交图标 -->
    <div class="social-icons" th:if="${theme.config.footer.social?.items != null and !theme.config.footer.social.items.isEmpty()}">
      <a
        th:each="link : ${theme.config.footer.social.items}"
        th:href="${link.url}"
        th:title="${link.text}"
        target="_blank"
        rel="noopener noreferrer"
      >
        <span th:class="${link.icon}"></span>
      </a>
    </div>
  </footer>
</aside>
