<div
  th:fragment="aside-bgmask"
  id="z-aside-bgmask"
  class="hidden"
  onclick="
    document.getElementById('z-aside').classList.remove('show');
    this.classList.add('hidden');
  "
></div>

<aside th:fragment="aside" id="z-aside">
  <th:block th:if="${post != null or singlePage != null}">
    <section
      class="widget toc-widget"
      id="catalog-widget"
      style="display: none"
      th:if="${(post != null and theme.config.custom.enable_post_toc != false and #annotations.getOrDefault(post, 'toc', 'true') == 'true') or (singlePage != null and theme.config.custom.enable_page_toc != false and #annotations.getOrDefault(singlePage, 'toc', 'false') == 'true')}"
    >
      <hgroup class="widget-title">
        <span class="title-text">文章目录</span>
        <a
          th:if="${post != null}"
          onclick="return false;"
          aria-label="点赞文章"
          x-data="postLike()"
          x-init="init()"
          @click="toggleLike()"
          :data-title="liked ? '已点赞' : '点赞'"
          :class="{ 'liked': liked }"
          th:data-count="${post?.stats?.upvote ?: 0}"
          th:data-name="${post?.metadata?.name}"
        >
          <span class="icon-[ph--heart-bold]" x-show="!liked"></span>
          <span class="icon-[ph--heart-fill]" x-show="liked"></span>
          <span class="like-count" x-show="count > 0" x-text="count"></span>
        </a>
        <a
          href="#content"
          aria-label="返回顶部"
          data-title="返回顶部"
          onclick="
            window.scrollTo({ top: 0, behavior: 'smooth' });
            return false;
          "
        >
          <span class="icon-[ph--arrow-circle-up-bold]"></span>
        </a>
        <a
          href="#comment"
          aria-label="评论区"
          data-title="评论区"
          onclick="
            document.getElementById('comment').scrollIntoView({ behavior: 'smooth' });
            return false;
          "
        >
          <span class="icon-[ph--chat-circle-text-bold]"></span>
        </a>
      </hgroup>

      <div class="widget-body widget-card toc-body">
        <nav id="catalog-content" class="toc-nav"></nav>
        <p id="no-toc-tip" class="no-toc" style="display: none">暂无目录信息</p>
      </div>
    </section>

    <script>
      (function () {
        function generateCatalog() {
          const article = document.querySelector(".article");
          const catalogWidget = document.getElementById("catalog-widget");
          const catalogContent = document.getElementById("catalog-content");
          const noTocTip = document.getElementById("no-toc-tip");

          if (!article || !catalogWidget || !catalogContent) return;

          const headers = Array.from(article.querySelectorAll("h1, h2, h3, h4, h5, h6"));
          if (headers.length === 0) {
            catalogWidget.style.display = "block";
            catalogContent.style.display = "none";
            noTocTip.style.display = "block";
            return;
          }

          // 显示组件
          catalogWidget.style.display = "block";
          catalogContent.style.display = "block";
          noTocTip.style.display = "none";
          catalogContent.innerHTML = "";

          // 构建嵌套树结构
          const root = { children: [] };
          const stack = [root]; // 栈中存储 { level, element, children }

          headers.forEach((header, index) => {
            if (!header.id) header.id = "heading-" + index;

            const level = parseInt(header.tagName.substring(1));
            const item = {
              id: header.id,
              text: header.textContent,
              level: level,
              children: [],
            };

            // 找到父级：栈顶元素的 level 必须小于当前 level
            while (stack.length > 1 && stack[stack.length - 1].level >= level) {
              stack.pop();
            }

            stack[stack.length - 1].children.push(item);
            stack.push(item);
          });

          // 递归渲染函数
          function renderTree(items) {
            if (!items.length) return null;
            const ol = document.createElement("ol");
            items.forEach((item) => {
              const li = document.createElement("li");
              li.dataset.id = item.id;

              const a = document.createElement("a");
              a.href = "#" + item.id;
              a.textContent = item.text;
              a.title = item.text;
              a.onclick = (e) => {
                e.preventDefault();
                const target = document.getElementById(item.id);
                if (target) {
                  target.scrollIntoView({ behavior: "smooth" });
                  history.pushState(null, null, "#" + item.id);
                  // 触发高亮动画
                  target.classList.remove("toc-highlight");
                  void target.offsetWidth; // 强制重排以重播动画
                  target.classList.add("toc-highlight");
                  // 动画结束后移除类名
                  setTimeout(() => target.classList.remove("toc-highlight"), 2000);
                }
              };

              li.appendChild(a);

              const childrenOl = renderTree(item.children);
              if (childrenOl) {
                li.appendChild(childrenOl);
              }
              ol.appendChild(li);
            });
            return ol;
          }

          const treeDom = renderTree(root.children);
          if (treeDom) catalogContent.appendChild(treeDom);

          // 滚动监听 (ScrollSpy)
          if (window.tocObserver) window.tocObserver.disconnect();

          const observerCallback = (entries) => {
            // 找出当前视口中可见的所有标题
            entries.forEach((entry) => {
              const li = catalogContent.querySelector(`li[data-id="${entry.target.id}"]`);
              if (!li) return;

              if (entry.isIntersecting) {
                li.classList.add("active");
              } else {
                li.classList.remove("active");
              }
            });

            // 处理高亮逻辑：如果多个 active，取最上面的一个；处理父级 has-active
            const activeLis = catalogContent.querySelectorAll("li.active");
            // 实际业务中，Intersecting 可能有多个，这里简单处理：
            // 更精确的做法是计算距离顶部最近的 header。
            // 为简化，我们这里结合 scroll 事件做简单的“可视区域”高亮
            // 实际上 IntersectionObserver 已经够用，但为了模拟 blog-v3 的 hasActiveChild

            // 清除所有 has-active
            catalogContent.querySelectorAll(".has-active").forEach((el) => el.classList.remove("has-active"));

            // 重新计算 has-active (父级高亮)
            // 这里我们只取第一个 active 的作为主激活点
            let currentActive = catalogContent.querySelector("li.active");
            // 如果有多个 active，通常取第一个或者根据 intersectionRatio
            // 这里的简单实现可能不够完美，但基本可用

            if (currentActive) {
              let parent = currentActive.parentElement.closest("li");
              while (parent) {
                parent.classList.add("has-active");
                parent = parent.parentElement.closest("li");
              }
            }
          };

          // 使用 IntersectionObserver 监听标题
          window.tocObserver = new IntersectionObserver(observerCallback, {
            rootMargin: "-80px 0px -70% 0px", // 调整触发区域，偏向屏幕顶部
          });
          headers.forEach((h) => window.tocObserver.observe(h));
        }

        generateCatalog();
      })();
    </script>
  </th:block>

  <th:block th:unless="${post != null or singlePage != null}">
    <th:block th:each="item : ${theme.config.aside.widgets.index}">
      <th:block th:switch="${item.widget}">
        <section th:case="'stats'" class="widget">
          <hgroup class="widget-title text-creative">博客统计</hgroup>
          <div class="widget-body widget-card">
            <dl class="dl-group small">
              <div>
                <dt>运营时长</dt>
                <dd id="site-runtime" th:title="'博客于' + ${theme.config.aside.basic.site_start_time} + '上线'">-</dd>
              </div>
              <div>
                <dt>上次更新</dt>
                <dd class="time-ago" id="latest-update-time" data-time="">-</dd>
                <script th:inline="javascript">
                  (function () {
                    var posts = /*[[${postFinder.listAll()}]]*/ [];
                    if (posts && posts.length > 0) {
                      var latest = posts.reduce(function (max, post) {
                        var time = post.spec && post.spec.publishTime;
                        return time && time > max ? time : max;
                      }, "");
                      if (latest) {
                        document.getElementById("latest-update-time").dataset.time = latest;
                      }
                    }
                  })();
                </script>
              </div>
              <div>
                <dt>文章数目</dt>
                <dd th:text="${postFinder.archives(1, 1).total}">0</dd>
              </div>
            </dl>
          </div>
        </section>

        <section th:case="'tech-info'" class="widget">
          <hgroup class="widget-title text-creative">技术信息</hgroup>
          <div class="widget-body widget-card">
            <dl class="dl-group medium">
              <div>
                <dt>构建平台</dt>
                <dd class="platform-halo"><img th:src="@{/assets/images/logo.png}" alt="Halo" /> Halo</dd>
              </div>
              <div>
                <dt>图片存储</dt>
                <dd th:text="${theme.config.aside.basic.image_hosting}">本地存储</dd>
              </div>
              <div>
                <dt>软件协议</dt>
                <dd>GPL-3.0</dd>
              </div>
              <div>
                <dt>文章许可</dt>
                <dd>
                  <a
                    th:href="${theme.config.aside.basic.license_url}"
                    th:text="${theme.config.aside.basic.license}"
                    target="_blank"
                    rel="noopener noreferrer"
                    >CC BY-NC-SA 4.0</a
                  >
                </dd>
              </div>
              <div>
                <dt>规范域名</dt>
                <dd
                  class="domain-text"
                  th:title="${site.url}"
                  th:with="tempUrl=${#strings.replace(#strings.replace(#strings.replace(site.url, 'https://', ''), 'http://', ''), 'www.', '')},
                            cleanUrl=${#strings.endsWith(tempUrl, '/') ? #strings.substring(tempUrl, 0, #strings.length(tempUrl) - 1) : tempUrl}"
                  th:text="${cleanUrl}"
                ></dd>
              </div>
            </dl>

            <div class="z-expand" x-data="{ expand: false }">
              <div class="expand-content" x-show="expand" x-collapse>
                <dl class="dl-group small build-info">
                  <div>
                    <dt>Theme</dt>
                    <dd>Clarity</dd>
                  </div>
                  <div>
                    <dt>Version</dt>
                    <dd th:text="${theme.spec.version}">1.0.0</dd>
                  </div>
                  <div>
                    <dt>Framework</dt>
                    <dd>Halo 2.x</dd>
                  </div>
                </dl>
              </div>
              <button class="toggle-btn in-place" @click="expand = !expand">
                <span class="icon-[ph--caret-double-down-bold] toggle-icon" :class="{ 'expand': expand }"></span>
                <span x-text="expand ? '收起构建信息' : '展开构建信息'"></span>
              </button>
            </div>
          </div>
        </section>

        <section
          th:case="'weather'"
          class="widget"
          th:if="${not #strings.isEmpty(theme.config.aside.weather?.seniverse_key)}"
        >
          <hgroup class="widget-title text-creative">天气预报</hgroup>
          <div
            class="widget-body widget-card"
            id="weather-container"
            th:data-key="${theme.config.aside.weather.seniverse_key}"
            th:data-icon-base="@{/assets/images}"
          >
            <div
              class="weather-init"
              style="
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 0.5em;
                padding: 0.75rem 1rem;
                font-size: 0.9em;
                color: var(--c-text-3);
              "
            >
              <span class="icon-[ph--spinner] animate-spin"></span>
              <span>加载中...</span>
            </div>
          </div>
          <script>
            (function initWeather() {
              const container = document.getElementById("weather-container");
              if (!container) return;

              if (window.mountWeather) {
                container.innerHTML = "";
                window.mountWeather(container, container.dataset.key, container.dataset.iconBase);
              } else {
                window.addEventListener("load", function () {
                  if (window.mountWeather) {
                    container.innerHTML = "";
                    window.mountWeather(container, container.dataset.key, container.dataset.iconBase);
                  }
                });
              }
            })();
          </script>
        </section>

        <section
          th:case="'moments'"
          class="widget"
          th:with="momentsTitle = ${item.moments_title ?: '微语'}, noTextConfig = ${item.moments_no_text}"
        >
          <hgroup class="widget-title">
            <span class="title-text text-creative" th:text="${momentsTitle}">微语</span>
            <a href="/moments" aria-label="查看全部" title="查看全部">
              <span class="icon-[ph--arrow-right-bold]"></span>
            </a>
          </hgroup>
          <div
            class="widget-body widget-card moments-widget"
            th:data-title="${momentsTitle}"
            th:data-no-text="${noTextConfig}"
          >
            <th:block th:with="momentCount = ${item.count ?: 3}">
              <th:block th:each="moment : ${momentFinder.list(1, momentCount).items}">
                <article
                  class="moment-item"
                  th:if="${not #strings.isEmpty(moment.spec.content.html) or (moment.spec.content.medium != null and not #lists.isEmpty(moment.spec.content.medium))}"
                  th:data-has-media="${moment.spec.content.medium != null and not #lists.isEmpty(moment.spec.content.medium)}"
                >
                  <script type="text/plain" class="moment-raw-html" th:utext="${moment.spec.content.html}"></script>
                  <a class="moment-content" th:href="|/moments/${moment.metadata.name}|"></a>
                  <div class="moment-meta">
                    <time class="moment-time" th:datetime="${moment.spec.releaseTime}">
                      <span class="icon-[ph--clock-bold]"></span>
                      <span th:text="${#temporals.format(moment.spec.releaseTime, 'MM-dd HH:mm')}"></span>
                    </time>
                    <div th:if="${not #lists.isEmpty(moment.spec.tags)}" class="moment-tags">
                      <a
                        th:each="tag,iterStat : ${moment.spec.tags}"
                        th:if="${iterStat.index &lt; 2}"
                        th:href="@{/moments(tag=${tag})}"
                        class="moment-tag"
                      >
                        <span class="tag-hash">#</span>
                        <span th:text="${tag}"></span>
                      </a>
                    </div>
                  </div>
                </article>
              </th:block>
              <div th:if="${momentFinder.list(1, 1).items.isEmpty()}" class="empty-tip">
                <span class="icon-[ph--shooting-star-bold]"></span>
                暂无微语
              </div>
            </th:block>
            <script>
              (function () {
                const widget = document.querySelector(".moments-widget");
                if (!widget) return;

                const items = Array.from(widget.querySelectorAll(".moment-item"));
                // 获取动态标题
                const momentsTitle = widget.dataset.title || "微语";
                // 获取配置的无文字文案
                const noTextConfig = widget.dataset.noText;

                // 如果完全没有内容则不展示
                if (!items.length) return;

                // 预编译 DOMParser
                const parser = new DOMParser();

                // 使用 requestIdleCallback 提升页面初渲染流畅度
                const run = () => {
                  items.forEach((item) => {
                    const hasMedia = item.dataset.hasMedia === "true";
                    let displayText = "";

                    // 从moment-raw-html脚本标签中获取HTML内容
                    const rawHtmlScript = item.querySelector(".moment-raw-html");
                    const raw = rawHtmlScript ? rawHtmlScript.textContent || rawHtmlScript.innerText || "" : "";

                    // 处理HTML内容
                    if (raw) {
                      // 内存解析 HTML
                      const doc = parser.parseFromString(raw, "text/html");

                      // 删除所有class="tag"元素的内容
                      const tagElements = doc.querySelectorAll(".tag");
                      tagElements.forEach((tag) => {
                        tag.textContent = "";
                      });

                      // 提取纯文本
                      const text = doc.body.textContent || doc.body.innerText || "";
                      displayText = text.trim();
                    }

                    // 判断显示逻辑
                    if (!displayText) {
                      if (hasMedia) {
                        // 有媒体资源但无文字，显示提示
                        if (noTextConfig && noTextConfig.trim()) {
                          // 使用配置的文案
                          displayText = noTextConfig.trim();
                        } else {
                          // 使用默认文案，包含动态标题
                          displayText = `此${momentsTitle}无文字，请点击查看。`;
                        }
                      } else {
                        // 既无文字又无媒体，隐藏（不知道会不会出现这种情况，但还预防一下）
                        item.style.display = "none";
                        return;
                      }
                    }

                    // 写入内容
                    const content = item.querySelector(".moment-content");
                    if (content) content.textContent = displayText;
                  });
                };

                // 使用 requestIdleCallback，如果浏览器不支持则 fallback
                window.requestIdleCallback ? requestIdleCallback(run) : run();
              })();
            </script>
          </div>
        </section>

        <section
          th:case="'community'"
          class="widget dim"
          th:if="${not #strings.isEmpty(theme.config.aside.community.image)}"
        >
          <hgroup class="widget-title text-creative" th:text="${theme.config.aside.community.title}">
            博客/技术社区
          </hgroup>
          <div class="widget-body widget-card with-bg">
            <img class="bg-img bg-right" th:src="${theme.config.aside.community.image}" alt="" loading="lazy" />
            <div class="comm-title text-creative" th:text="${theme.config.aside.community.name}">技术交流群</div>
            <p class="comm-tip">
              <span class="icon-[ph--chat-circle-dots-bold]"></span>
              <span th:text="${theme.config.aside.community.desc}">169994096</span>
            </p>
          </div>
        </section>

        <section th:case="'sponsor'" class="widget dim">
          <hgroup class="widget-title text-creative" th:text="${theme.config.aside.sponsor?.title} ?: '云计算支持'">
            云计算支持
          </hgroup>
          <a
            th:href="${theme.config.aside.sponsor?.url}"
            target="_blank"
            rel="noopener noreferrer"
            class="widget-body widget-card with-bg sponsor-card"
          >
            <img
              th:if="${not #strings.isEmpty(theme.config.aside.sponsor?.logo)}"
              th:src="${theme.config.aside.sponsor.logo}"
              th:alt="${theme.config.aside.sponsor?.name}"
              class="bg-img bg-right"
              loading="lazy"
            />
            <div class="sponsor-name text-creative" th:text="${theme.config.aside.sponsor?.name} ?: '赞助商'"></div>
            <p class="sponsor-tip">
              <span class="icon-[ph--cloud-bold]"></span>
              <span th:text="${theme.config.aside.sponsor?.desc} ?: '提供云计算服务'"></span>
            </p>
          </a>
        </section>

        <section th:case="'custom'" class="widget">
          <hgroup class="widget-title text-creative" th:text="${item.title}">自定义</hgroup>
          <div class="widget-body widget-card" th:utext="${item.content}"></div>
        </section>
      </th:block>
    </th:block>
  </th:block>

  <script th:inline="javascript">
    (function () {
      // 计算运营时长
      const startTime = /*[[${theme.config.aside.basic.site_start_time}]]*/ "";
      if (startTime) {
        const start = new Date(startTime).getTime();
        const now = Date.now();
        const days = Math.floor((now - start) / (1000 * 60 * 60 * 24));

        const years = Math.floor(days / 365);
        const remainingDays = days % 365;
        const months = Math.floor(remainingDays / 30);

        let text = "";
        if (years > 0) text += years + "年";
        if (months > 0) text += months + "个月";
        if (years === 0 && months === 0) text = days + "天";

        const el = document.getElementById("site-runtime");
        if (el) el.textContent = text;
      }

      // 计算相对时间
      document.querySelectorAll(".time-ago").forEach((el) => {
        const timeStr = el.getAttribute("data-time");
        if (timeStr) {
          const time = new Date(timeStr).getTime();
          const now = Date.now();
          const diff = now - time;
          const minutes = Math.floor(diff / (1000 * 60));
          const hours = Math.floor(diff / (1000 * 60 * 60));
          const days = Math.floor(diff / (1000 * 60 * 60 * 24));

          let text = "";
          if (days > 0) text = days + "天前";
          else if (hours > 0) text = hours + "小时前";
          else if (minutes > 0) text = minutes + "分钟前";
          else text = "刚刚";

          el.textContent = text;
          el.title = "更新于 " + new Date(timeStr).toLocaleString("zh-CN");
        }
      });
    })();
  </script>
</aside>
