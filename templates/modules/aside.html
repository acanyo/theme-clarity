<!-- 右侧边栏背景遮罩（移动端） -->
<div
  th:fragment="aside-bgmask"
  id="z-aside-bgmask"
  class="hidden"
  onclick="document.getElementById('z-aside').classList.remove('show'); this.classList.add('hidden')"
></div>

<aside th:fragment="aside" id="z-aside">
  <!-- 1. 文章/页面目录 (仅在文章页或独立页面显示) -->
  <th:block th:if="${post != null or singlePage != null}">
    <section class="widget toc-widget" id="catalog-widget" style="display: none;">
      <hgroup class="widget-title">
        <span class="title-text">文章目录</span>
        <a href="#content" aria-label="返回开头" title="返回开头" onclick="window.scrollTo({top: 0, behavior: 'smooth'}); return false;">
          <span class="icon-[ph--arrow-circle-up-bold]"></span>
        </a>
        <a href="#comment" aria-label="评论区" title="评论区" onclick="document.getElementById('comment').scrollIntoView({behavior: 'smooth'}); return false;">
          <span class="icon-[ph--chat-circle-text-bold]"></span>
        </a>
      </hgroup>
      
      <div class="widget-body widget-card toc-body">
        <nav id="catalog-content" class="toc-nav">
          <!-- 目录内容由 JS 生成 -->
        </nav>
        <p id="no-toc-tip" class="no-toc" style="display: none;">暂无目录信息</p>
      </div>
    </section>
    
    <!-- 目录生成脚本 -->
    <script>
      (function() {
        function generateCatalog() {
          const article = document.querySelector('.article');
          const catalogWidget = document.getElementById('catalog-widget');
          const catalogContent = document.getElementById('catalog-content');
          const noTocTip = document.getElementById('no-toc-tip');
  
          if (!article || !catalogWidget || !catalogContent) return;
  
          const headers = Array.from(article.querySelectorAll('h1, h2, h3, h4, h5, h6'));
          if (headers.length === 0) {
            catalogWidget.style.display = 'block';
            catalogContent.style.display = 'none';
            noTocTip.style.display = 'block';
            return;
          }
  
          // 显示组件
          catalogWidget.style.display = 'block';
          catalogContent.style.display = 'block';
          noTocTip.style.display = 'none';
          catalogContent.innerHTML = '';
  
          // 构建嵌套树结构
          const root = { children: [] };
          const stack = [root]; // 栈中存储 { level, element, children }
  
          headers.forEach((header, index) => {
            if (!header.id) header.id = 'heading-' + index;
            
            const level = parseInt(header.tagName.substring(1));
            const item = {
              id: header.id,
              text: header.textContent,
              level: level,
              children: []
            };
  
            // 找到父级：栈顶元素的 level 必须小于当前 level
            while (stack.length > 1 && stack[stack.length - 1].level >= level) {
              stack.pop();
            }
            
            stack[stack.length - 1].children.push(item);
            stack.push(item);
          });
  
          // 递归渲染函数
          function renderTree(items) {
            if (!items.length) return null;
            const ol = document.createElement('ol');
            items.forEach(item => {
              const li = document.createElement('li');
              li.dataset.id = item.id;
              
              const a = document.createElement('a');
              a.href = '#' + item.id;
              a.textContent = item.text;
              a.title = item.text;
              a.onclick = (e) => {
                e.preventDefault();
                document.getElementById(item.id).scrollIntoView({ behavior: 'smooth' });
                history.pushState(null, null, '#' + item.id);
              };
  
              li.appendChild(a);
              
              const childrenOl = renderTree(item.children);
              if (childrenOl) {
                li.appendChild(childrenOl);
              }
              ol.appendChild(li);
            });
            return ol;
          }
  
          const treeDom = renderTree(root.children);
          if (treeDom) catalogContent.appendChild(treeDom);
  
          // 滚动监听 (ScrollSpy)
          if (window.tocObserver) window.tocObserver.disconnect();
          
          const observerCallback = (entries) => {
            // 找出当前视口中可见的所有标题
            entries.forEach(entry => {
              const li = catalogContent.querySelector(`li[data-id="${entry.target.id}"]`);
              if (!li) return;
  
              if (entry.isIntersecting) {
                li.classList.add('active');
              } else {
                li.classList.remove('active');
              }
            });
            
            // 处理高亮逻辑：如果多个 active，取最上面的一个；处理父级 has-active
            const activeLis = catalogContent.querySelectorAll('li.active');
            // 实际业务中，Intersecting 可能有多个，这里简单处理：
            // 更精确的做法是计算距离顶部最近的 header。
            // 为简化，我们这里结合 scroll 事件做简单的“可视区域”高亮
            // 实际上 IntersectionObserver 已经够用，但为了模拟 blog-v3 的 hasActiveChild
            
            // 清除所有 has-active
            catalogContent.querySelectorAll('.has-active').forEach(el => el.classList.remove('has-active'));
            
            // 重新计算 has-active (父级高亮)
            // 这里我们只取第一个 active 的作为主激活点
            let currentActive = catalogContent.querySelector('li.active');
             // 如果有多个 active，通常取第一个或者根据 intersectionRatio
             // 这里的简单实现可能不够完美，但基本可用
            
             if (currentActive) {
               let parent = currentActive.parentElement.closest('li');
               while (parent) {
                 parent.classList.add('has-active');
                 parent = parent.parentElement.closest('li');
               }
             }
          };
  
          // 使用 IntersectionObserver 监听标题
          window.tocObserver = new IntersectionObserver(observerCallback, {
            rootMargin: '-80px 0px -70% 0px' // 调整触发区域，偏向屏幕顶部
          });
          headers.forEach(h => window.tocObserver.observe(h));
        }
  
        generateCatalog();
      })();
    </script>
  </th:block>

  <!-- 2. 根据配置动态渲染小组件 (通常用于首页) -->
  <th:block th:unless="${post != null or singlePage != null}">
    <th:block th:each="item : ${theme.config.aside.widgets.index}">
      <!-- 根据 item.widget 选择渲染对应组件 -->
      <th:block th:switch="${item.widget}">

        <!-- 博客统计 -->
        <section th:case="'stats'" class="widget">
          <hgroup class="widget-title text-creative">博客统计</hgroup>
          <div class="widget-body widget-card">
            <dl class="dl-group small">
              <div>
                <dt>运营时长</dt>
                <dd id="site-runtime" th:title="'博客于' + ${theme.config.aside.basic.site_start_time} + '上线'">-</dd>
              </div>
              <div>
                <dt>上次更新</dt>
                <dd class="time-ago" id="latest-update-time" data-time="">-</dd>
                <script th:inline="javascript">
                  (function() {
                    var posts = /*[[${postFinder.listAll()}]]*/ [];
                    if (posts && posts.length > 0) {
                      var latest = posts.reduce(function(max, post) {
                        var time = post.spec && post.spec.publishTime;
                        return time && time > max ? time : max;
                      }, '');
                      if (latest) {
                        document.getElementById('latest-update-time').dataset.time = latest;
                      }
                    }
                  })();
                </script>
              </div>
              <div>
                <dt>文章数目</dt>
                <dd th:text="${postFinder.archives(1, 1).total}">0</dd>
              </div>
            </dl>
          </div>
        </section>

        <!-- 技术信息 -->
        <section th:case="'tech-info'" class="widget">
          <hgroup class="widget-title text-creative">技术信息</hgroup>
          <div class="widget-body widget-card">
            <dl class="dl-group medium">
              <div>
                <dt>构建平台</dt>
                <dd class="platform-halo"><img th:src="@{/assets/images/logo.png}" alt="Halo" /> Halo</dd>
              </div>
              <div>
                <dt>图片存储</dt>
                <dd th:text="${theme.config.aside.basic.image_hosting}">本地存储</dd>
              </div>
              <div>
                <dt>软件协议</dt>
                <dd>GPL-3.0</dd>
              </div>
              <div>
                <dt>文章许可</dt>
                <dd>
                  <a th:href="${theme.config.aside.basic.license_url}" 
                     th:text="${theme.config.aside.basic.license}" 
                     target="_blank" 
                     rel="noopener noreferrer">CC BY-NC-SA 4.0</a>
                </dd>
              </div>
              <div>
                <dt>规范域名</dt>
                <dd class="domain-text" 
                    th:title="${site.url}" 
                    th:with="tempUrl=${#strings.replace(#strings.replace(#strings.replace(site.url, 'https://', ''), 'http://', ''), 'www.', '')},
                            cleanUrl=${#strings.endsWith(tempUrl, '/') ? #strings.substring(tempUrl, 0, #strings.length(tempUrl) - 1) : tempUrl}"
                    th:text="${cleanUrl}"></dd>
              </div>
            </dl>

            <!-- 可展开的构建信息 -->
            <div class="z-expand" x-data="{ expand: false }">
              <div class="expand-content" x-show="expand" x-collapse>
                <dl class="dl-group small build-info">
                  <div>
                    <dt>Theme</dt>
                    <dd>Clarity</dd>
                  </div>
                  <div>
                    <dt>Version</dt>
                    <dd th:text="${theme.spec.version}">1.0.0</dd>
                  </div>
                  <div>
                    <dt>Framework</dt>
                    <dd>Halo 2.x</dd>
                  </div>
                </dl>
              </div>
              <button class="toggle-btn in-place" @click="expand = !expand">
                <span class="icon-[ph--caret-double-down-bold] toggle-icon" :class="{ 'expand': expand }"></span>
                <span x-text="expand ? '收起构建信息' : '展开构建信息'"></span>
              </button>
            </div>
          </div>
        </section>

        <!-- 社区群组 -->
        <section th:case="'community'" class="widget dim" th:if="${not #strings.isEmpty(theme.config.aside.community.image)}">
          <hgroup class="widget-title text-creative" th:text="${theme.config.aside.community.title}">
            博客/技术社区
          </hgroup>
          <div class="widget-body widget-card with-bg">
            <img class="bg-img bg-right" th:src="${theme.config.aside.community.image}" alt="" loading="lazy" />
            <div class="comm-title text-creative" th:text="${theme.config.aside.community.name}">技术交流群</div>
            <p class="comm-tip">
              <span class="icon-[ph--chat-circle-dots-bold]"></span>
              <span th:text="${theme.config.aside.community.desc}">169994096</span>
            </p>
          </div>
        </section>

        <!-- 云计算支持 -->
        <section th:case="'sponsor'" class="widget dim">
          <hgroup class="widget-title text-creative" th:text="${theme.config.aside.sponsor?.title} ?: '云计算支持'">云计算支持</hgroup>
          <a th:href="${theme.config.aside.sponsor?.url}" target="_blank" rel="noopener noreferrer" class="widget-body widget-card with-bg sponsor-card">
            <img th:if="${not #strings.isEmpty(theme.config.aside.sponsor?.logo)}" th:src="${theme.config.aside.sponsor.logo}" th:alt="${theme.config.aside.sponsor?.name}" class="bg-img bg-right" loading="lazy" />
            <div class="sponsor-name text-creative" th:text="${theme.config.aside.sponsor?.name} ?: '赞助商'"></div>
            <p class="sponsor-tip">
              <span class="icon-[ph--cloud-bold]"></span>
              <span th:text="${theme.config.aside.sponsor?.desc} ?: '提供云计算服务'"></span>
            </p>
          </a>
        </section>

        <!-- 自定义组件 -->
        <section th:case="'custom'" class="widget">
          <hgroup class="widget-title text-creative" th:text="${item.title}">自定义</hgroup>
          <div class="widget-body widget-card" th:utext="${item.content}"></div>
        </section>

      </th:block>
    </th:block>
  </th:block>

  <!-- 侧边栏脚本 -->
  <script th:inline="javascript">
    (function () {
      // 计算运营时长
      const startTime = /*[[${theme.config.aside.basic.site_start_time}]]*/ "";
      if (startTime) {
        const start = new Date(startTime).getTime();
        const now = Date.now();
        const days = Math.floor((now - start) / (1000 * 60 * 60 * 24));

        const years = Math.floor(days / 365);
        const remainingDays = days % 365;
        const months = Math.floor(remainingDays / 30);

        let text = "";
        if (years > 0) text += years + "年";
        if (months > 0) text += months + "个月";
        if (years === 0 && months === 0) text = days + "天";

        const el = document.getElementById("site-runtime");
        if (el) el.textContent = text;
      }

      // 计算相对时间
      document.querySelectorAll(".time-ago").forEach((el) => {
        const timeStr = el.getAttribute("data-time");
        if (timeStr) {
          const time = new Date(timeStr).getTime();
          const now = Date.now();
          const diff = now - time;
          const minutes = Math.floor(diff / (1000 * 60));
          const hours = Math.floor(diff / (1000 * 60 * 60));
          const days = Math.floor(diff / (1000 * 60 * 60 * 24));

          let text = "";
          if (days > 0) text = days + "天前";
          else if (hours > 0) text = hours + "小时前";
          else if (minutes > 0) text = minutes + "分钟前";
          else text = "刚刚";

          el.textContent = text;
          el.title = "更新于 " + new Date(timeStr).toLocaleString("zh-CN");
        }
      });
    })();
  </script>
</aside>
