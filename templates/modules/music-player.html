<!-- 音乐胶囊播放器 -->
<th:block th:fragment="player">
  <!-- 调试日志 -->
  <script th:inline="javascript">
    console.log('Music Player Config:', {
      enabled: /*[[${theme.config.music?.enabled}]]*/ null,
      server: /*[[${theme.config.music?.server}]]*/ null,
      type: /*[[${theme.config.music?.type}]]*/ null,
      id: /*[[${theme.config.music?.id}]]*/ null
    });
  </script>

  <div
    th:if="${theme.config.music?.enabled == true and theme.config.music?.id != null and !#strings.isEmpty(theme.config.music.id)}"
    id="music-player"
    class="music-capsule"
    x-data="musicPlayer()"
    x-init="init()"
    :class="{ 'expanded': expanded, 'playing': playing }"
  >
  <!-- 胶囊主体（收起状态） -->
  <div class="capsule-body" @click="toggleExpand()">
    <!-- 专辑封面 -->
    <div class="cover-wrapper">
      <img
        :src="currentSong?.cover"
        :alt="currentSong?.title"
        class="cover-img"
        :class="{ 'spinning': playing }"
      />
      <!-- 播放状态指示器 -->
      <div class="play-indicator" x-show="playing">
        <span></span><span></span><span></span>
      </div>
    </div>

    <!-- 歌曲信息 -->
    <div class="song-info-mini">
      <div class="song-marquee">
        <span x-text="(currentSong?.title || '未播放') + ' - ' + (currentSong?.artist || '无信息')"></span>
      </div>
    </div>

    <!-- 展开指示器（展开时显示） -->
    <span class="icon-[ph--caret-up-bold] expand-arrow text-sm opacity-50" x-show="expanded"></span>

    <!-- 快捷播放/暂停（仅收起时显示） -->
    <button class="quick-play-btn" @click.stop="togglePlay()">
      <span :class="playing ? 'icon-[ph--pause-fill]' : 'icon-[ph--play-fill]'"></span>
    </button>
  </div>

  <!-- 展开面板 -->
  <div class="expand-panel" x-show="expanded" x-collapse>
    <!-- 歌曲详情 -->
    <div class="song-detail">
      <div class="song-title text-creative" x-text="currentSong?.title || '未知歌曲'"></div>
      <div class="song-artist" x-text="currentSong?.artist || '未知歌手'"></div>
    </div>

    <!-- 进度条 -->
    <div class="progress-wrapper">
      <span class="time-current" x-text="formatTime(currentTime)"></span>
      <div class="progress-bar" @click="seek($event)">
        <div class="progress-bg"></div>
        <div class="progress-fill" :style="{ width: progress + '%' }"></div>
        <div class="progress-thumb" :style="{ left: progress + '%' }"></div>
      </div>
      <span class="time-duration" x-text="formatTime(duration)"></span>
    </div>

    <!-- 歌词显示 -->
    <div
      th:if="${theme.config.music.show_lrc != false}"
      class="lyrics-wrapper"
      x-show="lyrics.length > 0"
    >
      <div class="lyrics-scroll" :style="{ transform: `translateY(${lyricsOffset}px)` }">
        <template x-for="(line, index) in lyrics" :key="index">
          <p
            class="lyric-line"
            :class="{ 'active': index === currentLyricIndex }"
            x-text="line.text"
          ></p>
        </template>
      </div>
    </div>

    <!-- 控制按钮 -->
    <div class="controls">
      <!-- 播放模式 -->
      <button class="ctrl-btn" @click="toggleOrder()" :title="orderMode === 'list' ? '列表循环' : '随机播放'">
        <span x-show="orderMode === 'list'" class="icon-[ph--repeat-bold]"></span>
        <span x-show="orderMode === 'random'" class="icon-[ph--shuffle-bold]"></span>
      </button>

      <!-- 上一首 -->
      <button class="ctrl-btn" @click="prev()" title="上一首">
        <span class="icon-[ph--skip-back-fill]"></span>
      </button>

      <!-- 播放/暂停 -->
      <button class="ctrl-btn main" @click="togglePlay()" :title="playing ? '暂停' : '播放'">
        <span x-show="!playing" class="icon-[ph--play-fill]"></span>
        <span x-show="playing" class="icon-[ph--pause-fill]"></span>
      </button>

      <!-- 下一首 -->
      <button class="ctrl-btn" @click="next()" title="下一首">
        <span class="icon-[ph--skip-forward-fill]"></span>
      </button>

      <!-- 音量 -->
      <div class="volume-control" x-data="{ showSlider: false }">
        <button
          class="ctrl-btn"
          @click="showSlider = !showSlider"
          @click.outside="showSlider = false"
          :title="'音量 ' + volume + '%'"
        >
          <span x-show="volume > 50" class="icon-[ph--speaker-high-fill]"></span>
          <span x-show="volume > 0 && volume <= 50" class="icon-[ph--speaker-low-fill]"></span>
          <span x-show="volume === 0" class="icon-[ph--speaker-x-fill]"></span>
        </button>
        <div class="volume-slider" x-show="showSlider" x-transition>
          <input
            type="range"
            min="0"
            max="100"
            :value="volume"
            @input="setVolume($event.target.value)"
          />
        </div>
      </div>
    </div>

    <!-- 歌曲列表（可选展开） -->
    <div class="playlist-toggle">
      <button @click="showPlaylist = !showPlaylist" class="playlist-btn">
        <span class="icon-[ph--playlist-bold]"></span>
        <span x-text="'播放列表 (' + playlist.length + ')'"></span>
        <span class="icon-[ph--caret-down-bold]" :class="{ 'rotate': showPlaylist }"></span>
      </button>
    </div>

    <div class="playlist-wrapper" x-show="showPlaylist" x-collapse>
      <div class="playlist-scroll">
        <template x-for="(song, index) in playlist" :key="song.id || index">
          <div
            class="playlist-item"
            :class="{ 'active': currentIndex === index }"
            @click="playSong(index)"
          >
            <span class="song-index" x-text="index + 1"></span>
            <div class="song-meta">
              <span class="song-name" x-text="song.title"></span>
              <span class="song-artist" x-text="song.artist"></span>
            </div>
            <span x-show="currentIndex === index && playing" class="icon-[ph--speaker-high-fill] now-playing"></span>
          </div>
        </template>
      </div>
    </div>
  </div>

  <!-- 隐藏的 Audio 元素 -->
  <audio
    x-ref="audio"
    :src="currentAudioUrl"
    @timeupdate="onTimeUpdate()"
    @ended="onEnded()"
    @loadedmetadata="onLoaded()"
    @error="onError()"
    preload="metadata"
  ></audio>
</div>

<!-- 音乐播放器配置（传递给 JS） -->
<script th:if="${theme.config.music?.enabled == true and theme.config.music?.id != null}" th:inline="javascript">
  window.MUSIC_CONFIG = {
    server: /*[[${theme.config.music.server}]]*/ 'netease',
    type: /*[[${theme.config.music.type}]]*/ 'playlist',
    id: /*[[${theme.config.music.id}]]*/ '',
    api_url: /*[[${theme.config.music.api_url}]]*/ '',
    order: /*[[${theme.config.music.order}]]*/ 'list',
    volume: /*[[${theme.config.music.volume}]]*/ 70,
    autoplay: /*[[${theme.config.music.autoplay}]]*/ false,
    showLrc: /*[[${theme.config.music.show_lrc}]]*/ true
  };
</script>
</th:block>
