<!doctype html>
<html xmlns:th="https://www.thymeleaf.org" th:replace="~{modules/layout :: html(content = ~{::content}, showAside = true)}">
  <th:block th:fragment="content">
    <!-- 页面标题 -->
    <div class="moments-header">
      <div class="moments-title">
        <span class="icon-[ph--shooting-star-bold]"></span>
        <h1 class="text-creative">瞬间</h1>
      </div>
      <a href="/moments/rss.xml" class="rss-link" title="RSS 订阅" target="_blank" rel="noopener">
        <span class="icon-[ph--rss-simple-bold]"></span>
        RSS 订阅
      </a>
    </div>

    <!-- 标签筛选 -->
    <nav th:if="${not #lists.isEmpty(tags)}" class="moments-tags scrollcheck-x">
      <a 
        th:href="@{/moments}" 
        class="tag-item"
        th:classappend="${#lists.isEmpty(param.tag)} ? 'active' : ''"
      >
        全部
      </a>
      <a
        th:each="tag : ${tags}"
        th:href="|/moments?tag=${tag.name}|"
        class="tag-item"
        th:classappend="${#lists.contains(param.tag, tag.name)} ? 'active' : ''"
      >
        <span th:text="${tag.name}"></span>
        <span class="tag-count" th:text="${tag.momentCount}"></span>
      </a>
    </nav>

    <!-- 瞬间列表 -->
    <div class="moments-list proper-height">
      <article 
        th:each="moment,iterStat : ${moments.items}" 
        th:with="content=${moment.spec.content}"
        class="moment-card"
        th:id="|moment-${moment.metadata.name}|"
        th:style="'--delay: ' + ${iterStat.index * 0.05} + 's'"
      >
        <!-- 作者信息 + 时间 -->
        <header class="moment-header">
          <div th:if="${moment.owner != null}" class="author-info">
            <img 
              th:if="${moment.owner.avatar != null}" 
              th:src="${moment.owner.avatar}" 
              th:alt="${moment.owner.displayName}" 
              class="author-avatar"
              loading="lazy"
            />
            <span class="author-name" th:text="${moment.owner.displayName}"></span>
          </div>
          <time 
            class="moment-time" 
            th:datetime="${moment.spec.releaseTime}"
            th:title="${#temporals.format(moment.spec.releaseTime, 'yyyy-MM-dd HH:mm')}"
          >
            <span class="icon-[ph--calendar-dots-bold]"></span>
            <span th:text="${#temporals.format(moment.spec.releaseTime, 'yyyy-MM-dd')}"></span>
          </time>
        </header>

        <!-- 瞬间内容 -->
        <div class="moment-body">
          <!-- 文本内容 -->
          <div 
            th:if="${not #strings.isEmpty(content.html)}" 
            class="moment-text"
            th:utext="${content.html}"
          ></div>

          <!-- 媒体内容 -->
          <div 
            th:if="${not #lists.isEmpty(content.medium)}" 
            class="moment-media"
            th:classappend="${#lists.size(content.medium) == 1 ? 'single' : (#lists.size(content.medium) == 2 ? 'double' : 'grid')}"
          >
            <th:block th:each="mediaItem : ${content.medium}">
              <!-- 图片 -->
              <figure th:if="${mediaItem.type.name == 'PHOTO'}" class="media-item photo">
                <img 
                  th:src="${mediaItem.url}" 
                  alt="瞬间图片"
                  loading="lazy"
                />
              </figure>
              
              <!-- 视频 -->
              <figure th:if="${mediaItem.type.name == 'VIDEO'}" class="media-item video">
                <video 
                  th:src="${mediaItem.url}" 
                  controls
                  preload="metadata"
                ></video>
              </figure>
              
              <!-- 音频 -->
              <figure th:if="${mediaItem.type.name == 'AUDIO'}" class="media-item audio">
                <audio 
                  th:src="${mediaItem.url}" 
                  controls
                ></audio>
              </figure>
            </th:block>
          </div>
        </div>

        <!-- 标签 + 操作栏 -->
        <footer class="moment-footer">
          <!-- 标签 -->
          <div th:if="${not #lists.isEmpty(moment.spec.tags)}" class="moment-tags">
            <a 
              th:each="tag : ${moment.spec.tags}"
              th:href="|/moments?tag=${tag}|"
              class="moment-tag"
            >
              <span class="tag-hash">#</span>
              <span th:text="${tag}"></span>
            </a>
          </div>

          <!-- 操作按钮 -->
          <div class="moment-actions">
            <button 
              class="action-btn comment" 
              title="评论"
              onclick="this.closest('.moment-card').querySelector('.moment-comment')?.classList.toggle('show')"
            >
              <span class="icon-[ph--chat-circle-bold]"></span>
              <span th:text="${moment.stats.approvedComment ?: 0}"></span>
            </button>
            <button 
              class="action-btn share" 
              title="复制链接"
              th:data-url="|/moments/${moment.metadata.name}|"
              onclick="navigator.clipboard.writeText(location.origin + this.dataset.url); this.classList.add('copied'); setTimeout(() => this.classList.remove('copied'), 2000)"
            >
              <span class="icon-[ph--link-bold]"></span>
            </button>
          </div>
        </footer>

        <!-- 评论区（折叠） -->
        <div th:if="${haloCommentEnabled}" class="moment-comment" th:id="|comment-${moment.metadata.name}|">
          <div class="comment-header">
            <span class="icon-[ph--chat-circle-text-bold]"></span>
            <span>评论</span>
          </div>
          <halo:comment group="moment.halo.run" kind="Moment" th:attr="name=${moment.metadata.name}" />
        </div>
      </article>

      <!-- 空状态 -->
      <div th:if="${#lists.isEmpty(moments.items)}" class="moments-empty">
        <span class="icon-[ph--shooting-star-bold]"></span>
        <p>暂无瞬间</p>
      </div>
    </div>

    <!-- 分页 -->
    <nav th:if="${moments.hasPrevious() or moments.hasNext()}" class="moments-pagination">
      <a 
        th:if="${moments.hasPrevious()}"
        th:href="@{${moments.prevUrl}}"
        class="page-btn"
      >
        <span class="icon-[ph--caret-left-bold]"></span>
        上一页
      </a>
      <span th:unless="${moments.hasPrevious()}" class="page-btn disabled">
        <span class="icon-[ph--caret-left-bold]"></span>
        上一页
      </span>

      <span class="page-info">
        <span th:text="${moments.page}"></span> / <span th:text="${moments.totalPages}"></span>
      </span>

      <a 
        th:if="${moments.hasNext()}"
        th:href="@{${moments.nextUrl}}"
        class="page-btn"
      >
        下一页
        <span class="icon-[ph--caret-right-bold]"></span>
      </a>
      <span th:unless="${moments.hasNext()}" class="page-btn disabled">
        下一页
        <span class="icon-[ph--caret-right-bold]"></span>
      </span>
    </nav>
  </th:block>
</html>
