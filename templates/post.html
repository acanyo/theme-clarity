<!doctype html>
<html
  xmlns:th="https://www.thymeleaf.org"
  th:replace="~{modules/layout :: html(content = ~{::content}, showAside = true, pageTitle = null)}"
>
  <th:block th:fragment="content">
    <div class="post-header" th:classappend="${(post.spec.cover != null and post.spec.cover != '' ? 'has-cover ' : '') + (theme.config.post.center_title ? 'center-title' : '')}">
      <img th:if="${post.spec.cover}" th:src="${post.spec.cover}" class="post-cover" th:alt="${post.spec.title}" />

      <div class="post-nav">
        <div class="operations">
          <button class="z-btn" id="share-btn" title="复制分享文本">
            <span class="icon-[ph--share-bold]"></span>
            <span>文字分享</span>
          </button>
          <button class="z-btn" id="poster-btn" title="生成分享海报">
            <span class="icon-[ph--image-bold]"></span>
            <span>海报分享</span>
          </button>
        </div>

        <div class="post-info">
          <th:block th:replace="~{modules/author-capsule :: capsule(author=${post.owner})}" />

          <span th:if="${post.spec.publishTime}">
            <span class="icon-[ph--calendar-dots-bold]"></span>
            <time th:text="${#temporals.format(post.spec.publishTime, 'yyyy-MM-dd')}"></time>
          </span>

          <span th:if="${post.stats.comment != null}">
            <span class="icon-[ph--chat-circle-dots-bold]"></span>
            <span th:text="${post.stats.comment}"></span> 评论
          </span>

          <span th:if="${not #lists.isEmpty(post.categories)}">
            <span class="icon-[ph--folder-bold]"></span>
            <a th:href="${post.categories[0].status.permalink}" th:text="${post.categories[0].spec.displayName}"></a>
          </span>

          <span th:if="${post.stats.visit != null}">
            <span class="icon-[ph--eye-bold]"></span>
            <span th:text="${post.stats.visit}"></span> 阅读
          </span>
        </div>
      </div>
      <h1 class="post-title text-creative" th:text="${post.spec.title}"></h1>
    </div>
    <div
      th:if="${theme.config.post.show_excerpt != false and post.status.excerpt != null and post.status.excerpt != ''}"
      class="md-excerpt gradient-card"
      th:with="
        enableAnimation = ${theme.config.post.excerpt?.animation != false},
        speed = ${theme.config.post.excerpt?.speed ?: 50},
        caret = ${theme.config.post.excerpt?.caret ?: '_'}
      "
      th:data-animation="${enableAnimation}"
      th:data-speed="${speed}"
      th:data-caret="${caret}"
    >
      <span class="icon-[ph--highlighter-bold]"></span>
      <span
        id="excerpt-text"
        th:data-text="${post.status.excerpt}"
        th:text="${enableAnimation ? '' : post.status.excerpt}"
      ></span
      ><span th:if="${enableAnimation}" id="excerpt-caret" class="excerpt-caret" th:text="${caret}"></span>
    </div>
    <script>
      (function () {
        const container = document.querySelector(".md-excerpt");
        if (!container || container.dataset.animation === "false") return;
        const el = document.getElementById("excerpt-text");
        const caret = document.getElementById("excerpt-caret");
        if (!el) return;
        const text = el.dataset.text || "";
        const speed = parseInt(container.dataset.speed) || 50;
        let index = 0;
        function type() {
          if (index < text.length) {
            el.textContent += text[index];
            index++;
            setTimeout(type, speed);
          } else {
            if (caret) caret.style.display = "none";
          }
        }
        type();
      })();
    </script>

    <div
      th:if="${theme.config.post.outdated_notice?.enabled != false and post.spec.publishTime != null}"
      class="outdated-notice"
      th:with="
        thresholdDays = ${theme.config.post.outdated_notice?.days ?: 180},
        message = ${theme.config.post.outdated_notice?.message ?: '本文发布于 {days} 天前，内容可能已过时，请注意甄别。'}
      "
      th:data-publish-time="${#temporals.format(post.spec.publishTime, 'yyyy-MM-dd''T''HH:mm:ss')}"
      th:data-threshold="${thresholdDays}"
      th:data-message="${message}"
      style="display: none"
    >
      <span class="icon-[ph--warning-circle-bold]"></span>
      <span class="notice-text"></span>
    </div>
    <script>
      (function () {
        const notice = document.querySelector(".outdated-notice");
        if (!notice) return;

        const publishTime = new Date(notice.dataset.publishTime).getTime();
        const threshold = parseInt(notice.dataset.threshold) || 180;
        const messageTemplate = notice.dataset.message;

        const now = Date.now();
        const daysPassed = Math.floor((now - publishTime) / (1000 * 60 * 60 * 24));

        if (daysPassed >= threshold) {
          const text = messageTemplate.replace("{days}", daysPassed);
          notice.querySelector(".notice-text").textContent = text;
          notice.style.display = "";
        }
      })();
    </script>

    <article class="article" th:utext="${post.content.content}"></article>

    <div class="post-footer">
      <section th:if="${not #lists.isEmpty(post.tags)}" class="tags-section">
        <div class="title text-creative">文章标签</div>
        <div class="content tags-list">
          <a
            th:each="tag : ${post.tags}"
            th:href="${tag.status.permalink}"
            class="tag-item"
            th:text="'#' + ${tag.spec.displayName}"
          ></a>
        </div>
      </section>

      <section class="license">
        <th:block th:with="isOriginal = ${#annotations.getOrDefault(post, 'post_author', 'true')}">
          <th:block th:if="${isOriginal == 'true'}">
            <div class="title text-creative">许可协议</div>
            <div class="content">
              本文采用
              <a
                th:with="hasPostLicense = ${#annotations.getOrDefault(post, 'post_license', 'false')}"
                th:href="${hasPostLicense ? #annotations.getOrDefault(post, 'post_license_url', '') : (theme.config.aside.basic.license_url ?: 'https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh-hans')}"
                target="_blank"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="1em"
                  height="1em"
                  viewBox="0 0 24 24"
                  style="vertical-align: -0.125em; display: inline"
                >
                  <path
                    fill="currentColor"
                    d="M9 8c1.104 0 2.105.448 2.829 1.173l-1.414 1.413a2 2 0 1 0 0 2.828l1.413 1.414A4.001 4.001 0 0 1 5 12c0-2.208 1.792-4 4-4m9.829 1.173A4.001 4.001 0 0 0 12 12a4.001 4.001 0 0 0 6.828 2.828l-1.414-1.414a2 2 0 1 1 0-2.828zM2 12C2 6.477 6.477 2 12 2s10 4.477 10 10s-4.477 10-10 10S2 17.523 2 12m10-8a8 8 0 1 0 0 16a8 8 0 0 0 0-16"
                  />
                </svg>
                <th:block th:if="${hasPostLicense}">
                  <span th:text="${#annotations.getOrDefault(post, 'post_license_text', '')}"></span>
                </th:block>
                <th:block th:unless="${hasPostLicense}">
                  <span
                    th:text="${theme.config.aside.basic.license ?: '署名-非商业性使用-相同方式共享 4.0 国际'}"
                  ></span>
                </th:block>
              </a>
              许可协议，转载请注明出处。
            </div>
          </th:block>
          <th:block
            th:unless="${isOriginal == 'true'}"
            th:with="originUrl=${#annotations.getOrDefault(post, 'post_original_url', '')},
                      originName=${#annotations.getOrDefault(post, 'post_original', '')},
                      replaceHtml=${'<a href=&quot;' + originUrl + '&quot; target=&quot;_blank&quot;>' + originName + '</a>'}"
          >
            <div class="title text-creative">文章来源</div>
            <div
              class="content"
              th:utext="${#strings.replace(
                      #annotations.getOrDefault(post, 'post_original_text', '此文来自 {post_original} ，侵删。'),
                      '{post_original}',
                      replaceHtml
              )}"
            ></div>
          </th:block>
        </th:block>
      </section>
    </div>

    <th:block
      th:with="
        prevPost = ${postFinder.cursor(post.metadata.name).previous},
        nextPost = ${postFinder.cursor(post.metadata.name).next}
      "
    >
      <div th:if="${prevPost != null or nextPost != null}" class="surround-post">
        <a th:if="${prevPost != null}" th:href="${prevPost.status.permalink}" class="surround-link">
          <span class="icon-[solar--rewind-back-bold-duotone] rtl-flip"></span>
          <div class="surround-text">
            <strong class="title text-creative" th:text="${prevPost.spec.title}"></strong>
            <span class="date" th:text="${#temporals.format(prevPost.spec.publishTime, 'yyyy-MM-dd')}"></span>
          </div>
        </a>
        <div th:unless="${prevPost != null}" class="surround-link no-link">
          <span class="icon-[solar--document-add-bold-duotone]"></span>
          <div class="surround-text">
            <strong class="title">新故事即将发生</strong>
          </div>
        </div>

        <a th:if="${nextPost != null}" th:href="${nextPost.status.permalink}" class="surround-link align-end">
          <span class="icon-[solar--rewind-forward-bold-duotone] rtl-flip"></span>
          <div class="surround-text">
            <strong class="title text-creative" th:text="${nextPost.spec.title}"></strong>
            <span class="date" th:text="${#temporals.format(nextPost.spec.publishTime, 'yyyy-MM-dd')}"></span>
          </div>
        </a>
        <div th:unless="${nextPost != null}" class="surround-link align-end no-link">
          <span class="icon-[solar--reel-bold-duotone]"></span>
          <div class="surround-text">
            <strong class="title">已抵达博客尽头</strong>
          </div>
        </div>
      </div>
    </th:block>

    <h3 th:if="${haloCommentEnabled}" class="comment-title">
      <span class="icon-[ph--chat-circle-text-bold]"></span>
      评论区
    </h3>
    <section th:if="${haloCommentEnabled}" class="z-comment" id="comment">
      <halo:comment group="content.halo.run" kind="Post" th:attr="name=${post.metadata.name}" />
    </section>

    <div id="poster-modal" class="poster-modal" style="display: none">
      <div class="poster-modal-overlay"></div>
      <div class="poster-modal-content">
        <button class="poster-close" id="poster-close">
          <span class="icon-[ph--x-bold]"></span>
        </button>
        <div class="poster-preview">
          <div class="poster-card" id="poster-card">
            <div class="poster-header">
              <img
                th:if="${post.spec.cover}"
                th:src="${post.spec.cover}"
                class="poster-cover"
                th:alt="${post.spec.title}"
                crossorigin="anonymous"
              />
              <div class="poster-gradient"></div>
            </div>
            <div class="poster-body">
              <h2 class="poster-title" th:text="${post.spec.title}"></h2>
              <p th:if="${post.status.excerpt}" class="poster-excerpt" th:text="${post.status.excerpt}"></p>
              <div class="poster-meta">
                <span
                  th:if="${post.spec.publishTime}"
                  th:text="${#temporals.format(post.spec.publishTime, 'yyyy-MM-dd')}"
                ></span>
                <span
                  th:if="${not #lists.isEmpty(post.categories)}"
                  th:text="${post.categories[0].spec.displayName}"
                ></span>
              </div>
            </div>
            <div class="poster-footer">
              <div class="poster-qrcode" id="poster-qrcode"></div>
              <div class="poster-site">
                <div class="poster-site-name" th:text="${site.title}"></div>
                <div class="poster-site-tip">扫码阅读全文</div>
              </div>
            </div>
          </div>
        </div>
        <div class="poster-actions">
          <button class="z-btn primary" id="poster-download">
            <span class="icon-[ph--download-bold]"></span>
            <span>保存海报</span>
          </button>
        </div>
      </div>
    </div>

    <script th:inline="javascript">
      (function () {
        const title = /*[[${post.spec.title}]]*/ "";
        const excerpt = /*[[${post.status.excerpt ?: ''}]]*/ "";
        const siteTitle = /*[[${site.title}]]*/ "";
        const url = window.location.href;

        // 文字分享
        const shareBtn = document.getElementById("share-btn");
        if (shareBtn) {
          const shareText = `【${siteTitle}】${title}\n\n${excerpt ? excerpt + "\n\n" : ""}${url}`;
          shareBtn.addEventListener("click", async () => {
            try {
              await navigator.clipboard.writeText(shareText);
              const icon = shareBtn.querySelector("span:first-child");
              const text = shareBtn.querySelector("span:last-child");
              icon.className = "icon-[ph--check-bold]";
              text.textContent = "已复制";
              setTimeout(() => {
                icon.className = "icon-[ph--share-bold]";
                text.textContent = "文字分享";
              }, 2000);
            } catch (err) {
              console.error("复制失败:", err);
            }
          });
        }

        // 海报分享
        const posterBtn = document.getElementById("poster-btn");
        const posterModal = document.getElementById("poster-modal");
        const posterClose = document.getElementById("poster-close");
        const posterDownload = document.getElementById("poster-download");
        const posterQrcode = document.getElementById("poster-qrcode");
        const posterCard = document.getElementById("poster-card");

        if (posterBtn && posterModal) {
          let qrGenerated = false;

          // 打开弹窗
          posterBtn.addEventListener("click", () => {
            posterModal.style.display = "flex";
            document.body.style.overflow = "hidden";

            // 生成二维码
            if (!qrGenerated && window.generateQRCode) {
              window.generateQRCode(posterQrcode, url);
              qrGenerated = true;
            }
          });

          // 关闭弹窗
          const closeModal = () => {
            posterModal.style.display = "none";
            document.body.style.overflow = "";
          };

          posterClose.addEventListener("click", closeModal);
          posterModal.querySelector(".poster-modal-overlay").addEventListener("click", closeModal);

          // 下载海报
          posterDownload.addEventListener("click", async () => {
            const icon = posterDownload.querySelector("span:first-child");
            const text = posterDownload.querySelector("span:last-child");

            icon.className = "icon-[ph--spinner] animate-spin";
            text.textContent = "生成中...";

            try {
              if (window.generatePoster) {
                await window.generatePoster(posterCard, title);
                icon.className = "icon-[ph--check-bold]";
                text.textContent = "已保存";
              }
            } catch (err) {
              console.error("生成失败:", err);
              icon.className = "icon-[ph--warning-bold]";
              text.textContent = "生成失败";
            }

            setTimeout(() => {
              icon.className = "icon-[ph--download-bold]";
              text.textContent = "保存海报";
            }, 2000);
          });
        }
      })();
    </script>
  </th:block>
</html>
