<!doctype html>
<html xmlns:th="https://www.thymeleaf.org" th:replace="~{modules/layout :: html(content = ~{::content}, showAside = true, pageTitle = null)}">
  <th:block th:fragment="content">
    <div class="post-header" th:classappend="${post.spec.cover != null and post.spec.cover != ''} ? 'has-cover' : ''">
      <!-- 封面图 -->
      <img th:if="${post.spec.cover}" th:src="${post.spec.cover}" class="post-cover" th:alt="${post.spec.title}" />

      <!-- 文章信息栏 -->
      <div class="post-nav">
        <!-- 分享按钮 -->
        <div class="operations">
          <button class="z-btn" id="share-btn" title="复制分享文本">
            <span class="icon-[ph--share-bold]"></span>
            <span>文字分享</span>
          </button>
        </div>

        <!-- 文章元信息 -->
        <div class="post-info">
          <!-- Author -->
          <th:block th:replace="~{modules/author-capsule :: capsule(author=${post.owner})}" />

          <span th:if="${post.spec.publishTime}">
            <span class="icon-[ph--calendar-dots-bold]"></span>
            <time th:text="${#temporals.format(post.spec.publishTime, 'yyyy-MM-dd')}"></time>
          </span>

          <span th:if="${post.stats.comment != null}">
            <span class="icon-[ph--chat-circle-dots-bold]"></span>
            <span th:text="${post.stats.comment}"></span> 评论
          </span>

          <span th:if="${not #lists.isEmpty(post.categories)}">
            <span class="icon-[ph--folder-bold]"></span>
            <a th:href="${post.categories[0].status.permalink}" th:text="${post.categories[0].spec.displayName}"></a>
          </span>

          <span th:if="${post.stats.visit != null}">
            <span class="icon-[ph--eye-bold]"></span>
            <span th:text="${post.stats.visit}"></span> 阅读
          </span>
        </div>
      </div>
      <h1 class="post-title text-creative" th:text="${post.spec.title}"></h1>
    </div>
    <div th:if="${theme.config.post.show_excerpt != false and post.status.excerpt != null and post.status.excerpt != ''}" class="md-excerpt gradient-card">
      <span class="icon-[ph--highlighter-bold]"></span>
      <span id="excerpt-text" th:text="${post.status.excerpt}"></span>
    </div>
    <article class="article" th:utext="${post.content.content}"></article>

    <div class="post-footer">
      <!-- 标签 -->
      <section th:if="${not #lists.isEmpty(post.tags)}" class="tags-section">
        <div class="title text-creative">文章标签</div>
        <div class="content tags-list">
          <a
            th:each="tag : ${post.tags}"
            th:href="${tag.status.permalink}"
            class="tag-item"
            th:text="'#' + ${tag.spec.displayName}"
          ></a>
        </div>
      </section>

      <!-- 许可协议 -->
      <section class="license">
        <div class="title text-creative">许可协议</div>
        <div class="content">本文采用 <a th:href="${theme.config.aside.basic.license_url ?: 'https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh-hans'}" target="_blank"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 24 24" style="vertical-align: -0.125em; display: inline;"><path fill="currentColor" d="M9 8c1.104 0 2.105.448 2.829 1.173l-1.414 1.413a2 2 0 1 0 0 2.828l1.413 1.414A4.001 4.001 0 0 1 5 12c0-2.208 1.792-4 4-4m9.829 1.173A4.001 4.001 0 0 0 12 12a4.001 4.001 0 0 0 6.828 2.828l-1.414-1.414a2 2 0 1 1 0-2.828zM2 12C2 6.477 6.477 2 12 2s10 4.477 10 10s-4.477 10-10 10S2 17.523 2 12m10-8a8 8 0 1 0 0 16a8 8 0 0 0 0-16"/></svg> <span th:text="${theme.config.aside.basic.license ?: '署名-非商业性使用-相同方式共享 4.0 国际'}"></span></a> 许可协议，转载请注明出处。</div>
      </section>
    </div>

    <!-- ==================== -->
    <!-- 5. 上下篇导航 (PostSurround) -->
    <!-- ==================== -->
    <th:block
      th:with="
        prevPost = ${postFinder.cursor(post.metadata.name).previous},
        nextPost = ${postFinder.cursor(post.metadata.name).next}
      "
    >
      <div th:if="${prevPost != null or nextPost != null}" class="surround-post">
        <!-- 上一篇 -->
        <a th:if="${prevPost != null}" th:href="${prevPost.status.permalink}" class="surround-link">
          <span class="icon-[solar--rewind-back-bold-duotone] rtl-flip"></span>
          <div class="surround-text">
            <strong class="title text-creative" th:text="${prevPost.spec.title}"></strong>
            <span class="date" th:text="${#temporals.format(prevPost.spec.publishTime, 'yyyy-MM-dd')}"></span>
          </div>
        </a>
        <div th:unless="${prevPost != null}" class="surround-link no-link">
          <span class="icon-[solar--document-add-bold-duotone]"></span>
          <div class="surround-text">
            <strong class="title">新故事即将发生</strong>
          </div>
        </div>

        <!-- 下一篇 -->
        <a th:if="${nextPost != null}" th:href="${nextPost.status.permalink}" class="surround-link align-end">
          <span class="icon-[solar--rewind-forward-bold-duotone] rtl-flip"></span>
          <div class="surround-text">
            <strong class="title text-creative" th:text="${nextPost.spec.title}"></strong>
            <span class="date" th:text="${#temporals.format(nextPost.spec.publishTime, 'yyyy-MM-dd')}"></span>
          </div>
        </a>
        <div th:unless="${nextPost != null}" class="surround-link align-end no-link">
          <span class="icon-[solar--reel-bold-duotone]"></span>
          <div class="surround-text">
            <strong class="title">已抵达博客尽头</strong>
          </div>
        </div>
      </div>
    </th:block>

    <!-- ==================== -->
    <!-- 6. 评论区 -->
    <!-- ==================== -->
    <h3 th:if="${haloCommentEnabled}" class="comment-title">
      <span class="icon-[ph--chat-circle-text-bold]"></span>
      评论区
    </h3>
    <section th:if="${haloCommentEnabled}" class="z-comment" id="comment">
      <halo:comment group="content.halo.run" kind="Post" th:attr="name=${post.metadata.name}" />
    </section>

    <!-- 分享脚本 -->
    <script th:inline="javascript">
      (function () {
        const shareBtn = document.getElementById("share-btn");
        if (shareBtn) {
          const title = /*[[${post.spec.title}]]*/ "";
          const excerpt = /*[[${post.status.excerpt ?: ''}]]*/ "";
          const url = window.location.href;
          const siteTitle = /*[[${site.title}]]*/ "";

          const shareText = `【${siteTitle}】${title}\n\n${excerpt ? excerpt + "\n\n" : ""}${url}`;

          shareBtn.addEventListener("click", async () => {
            try {
              await navigator.clipboard.writeText(shareText);
              const icon = shareBtn.querySelector("span:first-child");
              const text = shareBtn.querySelector("span:last-child");
              icon.className = "icon-[ph--check-bold]";
              text.textContent = "已复制";
              setTimeout(() => {
                icon.className = "icon-[ph--share-bold]";
                text.textContent = "文字分享";
              }, 2000);
            } catch (err) {
              console.error("复制失败:", err);
            }
          });
        }
      })();
    </script>
  </th:block>
</html>
