<!doctype html>
<html xmlns:th="https://www.thymeleaf.org" th:replace="~{modules/layout :: html(content = ~{::content}, showAside = true, pageTitle = null)}">
  <th:block th:fragment="content">
    <div class="moment-back">
      <a href="/moments" class="back-link">
        <span class="icon-[ph--arrow-left-bold]"></span>
        返回瞬间
      </a>
    </div>

    <article th:with="content=${moment.spec.content}" class="moment-detail" style="--delay: 0.1s">
      <header class="moment-header">
        <div th:if="${moment.owner != null}" class="author-info">
          <img 
            th:if="${moment.owner.avatar != null}" 
            th:src="${moment.owner.avatar}" 
            th:alt="${moment.owner.displayName}" 
            class="author-avatar"
            loading="lazy"
          />
          <span class="author-name" th:text="${moment.owner.displayName}"></span>
        </div>
        <time 
          class="moment-time" 
          th:datetime="${moment.spec.releaseTime}"
        >
          <span class="icon-[ph--calendar-dots-bold]"></span>
          <span th:text="${#temporals.format(moment.spec.releaseTime, 'yyyy-MM-dd HH:mm')}"></span>
        </time>
      </header>

      <div class="moment-body">
        <div 
          th:if="${not #strings.isEmpty(content.html)}" 
          class="moment-text"
          th:utext="${content.html}"
        ></div>

        <div 
          th:if="${not #lists.isEmpty(content.medium)}" 
          class="moment-media"
          th:classappend="${#lists.size(content.medium) == 1 ? 'single' : (#lists.size(content.medium) == 2 ? 'double' : 'grid')}"
        >
          <th:block th:each="mediaItem : ${content.medium}">
            <figure th:if="${mediaItem.type.name == 'PHOTO'}" class="media-item photo">
              <img 
                th:src="${mediaItem.url}" 
                alt="瞬间图片"
                loading="lazy"
              />
            </figure>
            
            <figure th:if="${mediaItem.type.name == 'VIDEO'}" class="media-item video">
              <video 
                th:src="${mediaItem.url}" 
                controls
                preload="metadata"
              ></video>
            </figure>
            
            <figure th:if="${mediaItem.type.name == 'AUDIO'}" class="media-item audio">
              <audio 
                th:src="${mediaItem.url}" 
                controls
              ></audio>
            </figure>
          </th:block>
        </div>
      </div>

      <footer class="moment-footer">
        <div th:if="${not #lists.isEmpty(moment.spec.tags)}" class="moment-tags">
          <a th:each="tag : ${moment.spec.tags}" 
             th:href="@{/moments(tag=${tag})}" 
             class="moment-tag">
            <span class="tag-hash">#</span>
            <span th:text="${tag}"></span>
          </a>
        </div>
        <div class="moment-actions">
          <button 
            class="action-btn like"
            title="点赞"
            x-data="{ 
              liked: localStorage.getItem('moment-liked-' + $el.dataset.name) === 'true',
              count: parseInt($el.dataset.count) || 0,
              loading: false,
              async toggle() {
                if (this.loading || this.liked) return;
                this.loading = true;
                try {
                  const res = await fetch('/apis/api.halo.run/v1alpha1/trackers/upvote', { 
                    method: 'POST',
                    headers: {
                      'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                      group: 'moment.halo.run',
                      plural: 'moments',
                      name: $el.dataset.name
                    })
                  });
                  if (res.ok) {
                    this.liked = true;
                    this.count++;
                    localStorage.setItem('moment-liked-' + $el.dataset.name, 'true');
                  } else {
                    console.error('Upvote failed:', res.status, await res.text());
                  }
                } catch(e) { console.error('Upvote error:', e); }
                this.loading = false;
              }
            }"
            :class="{ 'active': liked, 'loading': loading }"
            @click="toggle()"
            th:data-name="${moment.metadata.name}"
            th:data-count="${moment.stats.upvote ?: 0}"
          >
            <span class="icon-[ph--heart-bold]" x-show="!liked"></span>
            <span class="icon-[ph--heart-fill]" x-show="liked" style="display: none; color: #ef4444;"></span>
            <span x-text="count"></span>
          </button>
          <a href="#comment" class="action-btn comment" title="查看评论">
            <span class="icon-[ph--chat-circle-bold]"></span>
            <span th:text="${moment.stats.approvedComment ?: 0}"></span>
          </a>
          <button 
            class="action-btn share" 
            title="复制链接"
            onclick="navigator.clipboard.writeText(location.href); this.classList.add('copied'); setTimeout(() => this.classList.remove('copied'), 2000)"
          >
            <span class="icon-[ph--link-bold]"></span>
          </button>
        </div>
      </footer>
    </article>

    <section th:if="${haloCommentEnabled}" class="moment-comment-section">
      <h3 class="comment-title">
        <span class="icon-[ph--chat-circle-text-bold]"></span>
        评论
      </h3>
      <div class="z-comment" id="comment">
        <halo:comment group="moment.halo.run" kind="Moment" th:attr="name=${moment.metadata.name}" />
      </div>
    </section>
  </th:block>
</html>
