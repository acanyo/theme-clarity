<!doctype html>
<html xmlns:th="https://www.thymeleaf.org" th:replace="~{modules/layout :: html(content = ~{::content}, showAside = true)}">
  <th:block th:fragment="content">
    <!-- 返回链接 -->
    <div class="moment-back">
      <a href="/moments" class="back-link">
        <span class="icon-[ph--arrow-left-bold]"></span>
        返回瞬间
      </a>
    </div>

    <!-- 瞬间详情 -->
    <article th:with="content=${moment.spec.content}" class="moment-detail">
      <!-- 头部：作者 + 时间 -->
      <header class="moment-header">
        <div th:if="${moment.owner != null}" class="author-info">
          <img 
            th:if="${moment.owner.avatar != null}" 
            th:src="${moment.owner.avatar}" 
            th:alt="${moment.owner.displayName}" 
            class="author-avatar"
            loading="lazy"
          />
          <span class="author-name" th:text="${moment.owner.displayName}"></span>
        </div>
        <time 
          class="moment-time" 
          th:datetime="${moment.spec.releaseTime}"
        >
          <span class="icon-[ph--calendar-dots-bold]"></span>
          <span th:text="${#temporals.format(moment.spec.releaseTime, 'yyyy-MM-dd HH:mm')}"></span>
        </time>
      </header>

      <!-- 瞬间内容 -->
      <div class="moment-body">
        <!-- 文本内容 -->
        <div 
          th:if="${not #strings.isEmpty(content.html)}" 
          class="moment-text"
          th:utext="${content.html}"
        ></div>

        <!-- 媒体内容 -->
        <div 
          th:if="${not #lists.isEmpty(content.medium)}" 
          class="moment-media"
          th:classappend="${#lists.size(content.medium) == 1} ? 'single' : (#lists.size(content.medium) == 2 ? 'double' : 'grid')"
        >
          <th:block th:each="mediaItem : ${content.medium}">
            <!-- 图片 -->
            <figure th:if="${mediaItem.type.name == 'PHOTO'}" class="media-item photo">
              <img 
                th:src="${mediaItem.url}" 
                alt="瞬间图片"
                loading="lazy"
              />
            </figure>
            
            <!-- 视频 -->
            <figure th:if="${mediaItem.type.name == 'VIDEO'}" class="media-item video">
              <video 
                th:src="${mediaItem.url}" 
                controls
                preload="metadata"
              ></video>
            </figure>
            
            <!-- 音频 -->
            <figure th:if="${mediaItem.type.name == 'AUDIO'}" class="media-item audio">
              <audio 
                th:src="${mediaItem.url}" 
                controls
              ></audio>
            </figure>
          </th:block>
        </div>
      </div>

      <!-- 底部操作栏 -->
      <footer class="moment-footer">
        <div class="moment-actions">
          <!-- 点赞按钮 -->
          <button 
            class="action-btn like"
            title="点赞"
            x-data="{ 
              liked: localStorage.getItem('moment-liked-' + $el.dataset.name) === 'true',
              count: parseInt($el.dataset.count) || 0,
              loading: false,
              async toggle() {
                if (this.loading || this.liked) return;
                this.loading = true;
                try {
                  console.log('Upvoting moment:', $el.dataset.name);
                  const res = await fetch('/apis/api.halo.run/v1alpha1/trackers/upvote', { 
                    method: 'POST',
                    headers: {
                      'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                      group: 'moment.halo.run',
                      plural: 'moments',
                      name: $el.dataset.name
                    })
                  });
                  if (res.ok) {
                    this.liked = true;
                    this.count++;
                    localStorage.setItem('moment-liked-' + $el.dataset.name, 'true');
                    console.log('Upvote success');
                  } else {
                    console.error('Upvote failed:', res.status, await res.text());
                  }
                } catch(e) { console.error('Upvote error:', e); }
                this.loading = false;
              }
            }"
            :class="{ 'active': liked, 'loading': loading }"
            @click="toggle()"
            th:data-name="${moment.metadata.name}"
            th:data-count="${moment.stats.upvote ?: 0}"
          >
            <span class="icon-[ph--heart-bold]" x-show="!liked"></span>
            <span class="icon-[ph--heart-fill]" x-show="liked" style="display: none; color: #ef4444;"></span>
            <span x-text="count"></span>
          </button>
          <!-- 评论数 -->
          <span class="action-btn comment">
            <span class="icon-[ph--chat-circle-bold]"></span>
            <span th:text="${moment.stats.approvedComment ?: 0}"></span>
          </span>
          <!-- 分享按钮 -->
          <button 
            class="action-btn share" 
            title="复制链接"
            onclick="navigator.clipboard.writeText(location.href); this.classList.add('copied'); setTimeout(() => this.classList.remove('copied'), 2000)"
          >
            <span class="icon-[ph--link-bold]"></span>
          </button>
        </div>
      </footer>
    </article>

    <!-- 评论区 -->
    <section th:if="${haloCommentEnabled}" class="moment-comment-section">
      <h3 class="comment-title">
        <span class="icon-[ph--chat-circle-text-bold]"></span>
        评论
      </h3>
      <div class="z-comment" id="comment">
        <halo:comment group="moment.halo.run" kind="Moment" th:attr="name=${moment.metadata.name}" />
      </div>
    </section>
  </th:block>
</html>
